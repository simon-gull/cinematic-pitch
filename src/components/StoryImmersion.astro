---
interface Beat {
  text: string
  position: 'left' | 'right' | 'center'
  image?: string
  image_behavior?: 'fade-in' | 'fade-out' | 'parallax' | 'hold'
}

interface Props {
  beats: Beat[]
  logline?: string
}

const { beats = [], logline = '' } = Astro.props
---

<section class="story-immersion" style="background: #0A0A0A;">
  <div class="h-[6vh]"></div>

  {beats.map((beat, i) => (
    <div
      class="beat-block relative min-h-[35vh] flex items-center px-6 md:px-16 lg:px-24 py-8 md:py-12"
      data-beat-index={i}
    >
      {beat.position === 'left' && (
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-10 w-full max-w-7xl mx-auto items-center">
          <div class="beat-text opacity-0" data-beat-text>
            <p class="font-display text-xl md:text-2xl lg:text-3xl font-light leading-snug text-pitch-white">
              {beat.text}
            </p>
          </div>
          {beat.image && (
            <div class="beat-image opacity-0 overflow-hidden" data-beat-image data-behavior={beat.image_behavior || 'fade-in'}>
              <img src={beat.image} alt="" class="w-full h-auto object-cover" style="aspect-ratio: 16/10;" />
            </div>
          )}
        </div>
      )}

      {beat.position === 'right' && (
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-10 w-full max-w-7xl mx-auto items-center">
          {beat.image && (
            <div class="beat-image opacity-0 overflow-hidden order-2 md:order-1" data-beat-image data-behavior={beat.image_behavior || 'fade-in'}>
              <img src={beat.image} alt="" class="w-full h-auto object-cover" style="aspect-ratio: 16/10;" />
            </div>
          )}
          <div class="beat-text opacity-0 order-1 md:order-2" data-beat-text>
            <p class="font-display text-xl md:text-2xl lg:text-3xl font-light leading-snug text-pitch-white">
              {beat.text}
            </p>
          </div>
        </div>
      )}

      {beat.position === 'center' && (
        <div class="w-full max-w-3xl mx-auto text-center">
          <div class="beat-text opacity-0" data-beat-text>
            <p class="font-display text-xl md:text-2xl lg:text-3xl font-light leading-snug text-pitch-white">
              {beat.text}
            </p>
          </div>
        </div>
      )}
    </div>
  ))}

  {/* Logline — the snap */}
  {logline && (
    <div class="logline-block min-h-[60vh] flex items-center justify-center px-6 md:px-16">
      <p class="logline-text font-display text-lg md:text-2xl lg:text-3xl font-light leading-relaxed text-center max-w-3xl text-pitch-white opacity-0" data-logline>
        {logline}
      </p>
    </div>
  )}

  <div class="h-[6vh]"></div>
</section>

<script>
  import { gsap } from 'gsap'
  import { ScrollTrigger } from 'gsap/ScrollTrigger'
  gsap.registerPlugin(ScrollTrigger)

  // Text — scrub-based for smooth bidirectional control
  document.querySelectorAll('[data-beat-text]').forEach(el => {
    const block = el.closest('.beat-block')
    if (!block) return

    gsap.fromTo(el,
      { opacity: 0, y: 25, filter: 'blur(3px)' },
      {
        opacity: 1, y: 0, filter: 'blur(0px)',
        ease: 'power2.out',
        scrollTrigger: {
          trigger: block,
          start: 'top 80%',
          end: 'top 40%',
          scrub: 0.4,
        }
      }
    )
  })

  // Images — smooth scrub-based fade with parallax
  document.querySelectorAll('[data-beat-image]').forEach(el => {
    const behavior = el.getAttribute('data-behavior') || 'fade-in'
    const block = el.closest('.beat-block')
    if (!block) return
    const img = el.querySelector('img')

    // Fade in via scrub — always reversible
    gsap.fromTo(el,
      { opacity: 0, scale: 1.03 },
      {
        opacity: 1, scale: 1,
        ease: 'power2.out',
        scrollTrigger: {
          trigger: block,
          start: 'top 75%',
          end: 'top 35%',
          scrub: 0.5,
        }
      }
    )

    // Subtle parallax on all images
    if (img) {
      gsap.fromTo(img,
        { y: 25 },
        {
          y: -25,
          ease: 'none',
          scrollTrigger: {
            trigger: block,
            start: 'top bottom',
            end: 'bottom top',
            scrub: 0.6,
          }
        }
      )
    }
  })

  // Logline — scrub-based emergence
  document.querySelectorAll('[data-logline]').forEach(el => {
    const block = el.closest('.logline-block')
    if (!block) return

    gsap.fromTo(el,
      { opacity: 0, y: 15, letterSpacing: '0.02em' },
      {
        opacity: 1, y: 0, letterSpacing: '0em',
        ease: 'power2.out',
        scrollTrigger: {
          trigger: block,
          start: 'top 70%',
          end: 'top 35%',
          scrub: 0.5,
        }
      }
    )
  })
</script>
