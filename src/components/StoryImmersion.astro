---
interface Beat {
  text: string
  position: 'left' | 'right' | 'center'
  image?: string
  image_behavior?: 'fade-in' | 'fade-out' | 'parallax' | 'hold'
}

interface Props {
  beats: Beat[]
  logline?: string
}

const { beats = [], logline = '' } = Astro.props
---

<section class="story-immersion" style="background: #0A0A0A;">
  <!-- Spacing before -->
  <div class="h-[30vh]"></div>

  {beats.map((beat, i) => (
    <div
      class="beat-block relative min-h-screen flex items-center px-6 md:px-16 lg:px-24"
      data-beat-index={i}
    >
      {beat.position === 'left' && (
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-16 w-full max-w-7xl mx-auto items-center">
          <div class="beat-text opacity-0" data-beat-text>
            <p class="font-display text-2xl md:text-4xl lg:text-[42px] font-light leading-snug text-pitch-white">
              {beat.text}
            </p>
          </div>
          {beat.image && (
            <div class="beat-image opacity-0 overflow-hidden" data-beat-image data-behavior={beat.image_behavior || 'fade-in'}>
              <img src={beat.image} alt="" class="w-full h-auto object-cover" style="aspect-ratio: 16/10;" />
            </div>
          )}
        </div>
      )}

      {beat.position === 'right' && (
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-16 w-full max-w-7xl mx-auto items-center">
          {beat.image && (
            <div class="beat-image opacity-0 overflow-hidden order-2 md:order-1" data-beat-image data-behavior={beat.image_behavior || 'fade-in'}>
              <img src={beat.image} alt="" class="w-full h-auto object-cover" style="aspect-ratio: 16/10;" />
            </div>
          )}
          <div class="beat-text opacity-0 order-1 md:order-2" data-beat-text>
            <p class="font-display text-2xl md:text-4xl lg:text-[42px] font-light leading-snug text-pitch-white">
              {beat.text}
            </p>
          </div>
        </div>
      )}

      {beat.position === 'center' && (
        <div class="w-full max-w-3xl mx-auto text-center">
          <div class="beat-text opacity-0" data-beat-text>
            <p class="font-display text-2xl md:text-4xl lg:text-5xl font-light leading-snug text-pitch-white">
              {beat.text}
            </p>
          </div>
        </div>
      )}
    </div>
  ))}

  {/* Logline â€” the snap */}
  {logline && (
    <div class="logline-block min-h-screen flex items-center justify-center px-6 md:px-16">
      <p class="logline-text font-display text-xl md:text-3xl lg:text-4xl font-light leading-relaxed text-center max-w-4xl text-pitch-white opacity-0" data-logline>
        {logline}
      </p>
    </div>
  )}

  <!-- Spacing after -->
  <div class="h-[20vh]"></div>
</section>

<script>
  import { gsap } from 'gsap'
  import { ScrollTrigger } from 'gsap/ScrollTrigger'
  gsap.registerPlugin(ScrollTrigger)

  // Animate each beat
  document.querySelectorAll('[data-beat-text]').forEach(el => {
    gsap.fromTo(el,
      { opacity: 0, y: 40 },
      {
        opacity: 1, y: 0,
        duration: 1.2,
        ease: 'power2.out',
        scrollTrigger: {
          trigger: el.closest('.beat-block'),
          start: 'top 70%',
          toggleActions: 'play none none none',
        }
      }
    )
  })

  document.querySelectorAll('[data-beat-image]').forEach(el => {
    const behavior = el.getAttribute('data-behavior') || 'fade-in'
    const block = el.closest('.beat-block')
    if (!block) return

    if (behavior === 'fade-in' || behavior === 'hold') {
      gsap.fromTo(el,
        { opacity: 0 },
        {
          opacity: 1,
          duration: 1.5,
          ease: 'power2.out',
          scrollTrigger: {
            trigger: block,
            start: 'top 65%',
            toggleActions: 'play none none none',
          }
        }
      )
    }

    if (behavior === 'fade-out') {
      gsap.fromTo(el,
        { opacity: 0 },
        {
          opacity: 1,
          duration: 1,
          ease: 'power2.out',
          scrollTrigger: {
            trigger: block,
            start: 'top 65%',
            toggleActions: 'play none none none',
          }
        }
      )
      gsap.to(el, {
        opacity: 0,
        scrollTrigger: {
          trigger: block,
          start: 'bottom 60%',
          end: 'bottom 20%',
          scrub: true,
        }
      })
    }

    if (behavior === 'parallax') {
      gsap.fromTo(el,
        { opacity: 0, y: 60 },
        {
          opacity: 1, y: -40,
          ease: 'none',
          scrollTrigger: {
            trigger: block,
            start: 'top bottom',
            end: 'bottom top',
            scrub: true,
          }
        }
      )
    }
  })

  // Logline
  document.querySelectorAll('[data-logline]').forEach(el => {
    gsap.fromTo(el,
      { opacity: 0, y: 30 },
      {
        opacity: 1, y: 0,
        duration: 1.5,
        ease: 'power2.out',
        scrollTrigger: {
          trigger: el.closest('.logline-block'),
          start: 'top 60%',
          toggleActions: 'play none none none',
        }
      }
    )
  })
</script>
