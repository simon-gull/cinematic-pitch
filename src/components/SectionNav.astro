---
interface NavItem {
  id: string
  label: string
}

interface Props {
  items: NavItem[]
}

const { items = [] } = Astro.props
---

<nav id="section-nav" aria-label="Section navigation">
  {items.map((item, i) => (
    <button
      class="nav-dot"
      data-nav-target={`section-${item.id}`}
      data-nav-index={i}
      aria-label={`Go to ${item.label}`}
    >
      <span class="nav-label">{item.label}</span>
      <span class="dot"></span>
    </button>
  ))}
  <div class="nav-counter">
    <span id="nav-current">1</span> / <span id="nav-total">{items.length}</span>
  </div>
</nav>

<script>
  const nav = document.getElementById('section-nav')
  const dots = document.querySelectorAll('.nav-dot')
  const currentEl = document.getElementById('nav-current')
  const sections = document.querySelectorAll('[data-section]')

  if (!nav || !sections.length) {
    // No nav needed
  } else {
    let scrollTimer: ReturnType<typeof setTimeout> | null = null
    let isScrolling = false
    let navVisible = false
    let gateOpen = false

    // Wait for gate to open before showing nav
    const observer = new MutationObserver(() => {
      if (!document.body.classList.contains('scroll-locked')) {
        gateOpen = true
        observer.disconnect()
      }
    })
    observer.observe(document.body, { attributes: true, attributeFilter: ['class'] })

    // Show/hide nav based on scroll activity
    function showNav() {
      if (!gateOpen) return
      if (!navVisible) {
        nav!.classList.add('visible')
        navVisible = true
      }
    }

    function hideNav() {
      if (navVisible) {
        nav!.classList.remove('visible')
        navVisible = false
      }
    }

    // Track scroll to show/hide nav and update active section
    window.addEventListener('scroll', () => {
      if (!gateOpen) return

      // Show nav
      showNav()

      // Reset hide timer
      if (scrollTimer) clearTimeout(scrollTimer)
      isScrolling = true

      scrollTimer = setTimeout(() => {
        isScrolling = false
        // Keep nav visible when not scrolling (user stopped)
        showNav()

        // Hide after 3 seconds of no scroll
        scrollTimer = setTimeout(() => {
          hideNav()
        }, 3000)
      }, 150)

      // Update active section
      updateActiveSection()
    })

    function updateActiveSection() {
      const viewportMiddle = window.innerHeight / 2
      let activeIndex = 0

      sections.forEach((section, i) => {
        const rect = section.getBoundingClientRect()
        if (rect.top < viewportMiddle && rect.bottom > 0) {
          activeIndex = i
        }
      })

      dots.forEach((dot, i) => {
        dot.classList.toggle('active', i === activeIndex)
      })

      if (currentEl) {
        currentEl.textContent = String(activeIndex + 1)
      }
    }

    // Click to navigate
    dots.forEach(dot => {
      dot.addEventListener('click', () => {
        const targetId = dot.getAttribute('data-nav-target')
        if (!targetId) return
        const target = document.getElementById(targetId)
        if (!target) return

        target.scrollIntoView({ behavior: 'smooth' })
      })
    })

    // Initial state
    updateActiveSection()
  }
</script>
