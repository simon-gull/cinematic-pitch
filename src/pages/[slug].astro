---
import fs from 'node:fs'
import path from 'node:path'
import yaml from 'js-yaml'
import Layout from '../layouts/Layout.astro'
import EntryGate from '../components/EntryGate.astro'
import Hook from '../components/Hook.astro'
import StoryImmersion from '../components/StoryImmersion.astro'
import Mood from '../components/Mood.astro'
import World from '../components/World.astro'
import Characters from '../components/Characters.astro'
import Vision from '../components/Vision.astro'
import Themes from '../components/Themes.astro'
import Credibility from '../components/Credibility.astro'
import CTA from '../components/CTA.astro'
import SectionNav from '../components/SectionNav.astro'

export function getStaticPaths() {
  const contentDir = path.join(process.cwd(), 'src', 'content')
  const files = fs.readdirSync(contentDir).filter(f => f.endsWith('.yaml') || f.endsWith('.yml'))

  return files.map(file => {
    const raw = fs.readFileSync(path.join(contentDir, file), 'utf-8')
    const data = yaml.load(raw) as any
    return {
      params: { slug: data.slug || file.replace(/\.(yaml|yml)$/, '') },
      props: { project: data }
    }
  })
}

const { project } = Astro.props
const sections = project.sections || ['hook', 'story_immersion', 'mood', 'world', 'characters', 'vision', 'themes', 'credibility', 'cta']
const audioSrc = project.audio?.file || ''

const sectionLabels: Record<string, string> = {
  hook: 'Opening',
  story_immersion: 'Story',
  mood: 'Mood',
  world: 'World',
  characters: 'Characters',
  vision: 'Director',
  themes: 'Themes',
  credibility: 'Credentials',
  cta: 'Contact',
}

// Build nav items from active sections
const navItems = sections
  .filter((key: string) => project[key] || (key === 'characters' && project.characters))
  .map((key: string) => ({ id: key, label: sectionLabels[key] || key }))
---

<Layout
  title={`${project.title} â€” ${project.format || ''}`}
  description={project.subtitle || ''}
>
  <EntryGate
    title={project.title}
    format={project.format}
    audioSrc={audioSrc}
  />

  <SectionNav items={navItems} />

  <main>
    {sections.map((sectionKey: string) => {
      if (sectionKey === 'hook' && project.hook) {
        return (
          <div id="section-hook" data-section="hook">
            <Hook
              type={project.hook.type || 'image'}
              media={project.hook.media}
              tagline={project.hook.tagline}
              overlayLines={project.hook.overlay_lines}
            />
          </div>
        )
      }

      if (sectionKey === 'story_immersion' && project.story_immersion) {
        return (
          <div id="section-story_immersion" data-section="story_immersion">
            <StoryImmersion
              beats={project.story_immersion.beats}
              logline={project.story_immersion.logline}
            />
          </div>
        )
      }

      if (sectionKey === 'mood' && project.mood) {
        return (
          <div id="section-mood" data-section="mood">
            <Mood
              description={project.mood.description}
              stills={project.mood.stills}
            />
          </div>
        )
      }

      if (sectionKey === 'world' && project.world) {
        return (
          <div id="section-world" data-section="world">
            <World
              text={project.world.text}
              visual={project.world.visual}
            />
          </div>
        )
      }

      if (sectionKey === 'characters' && project.characters) {
        return (
          <div id="section-characters" data-section="characters">
            <Characters
              characters={project.characters}
            />
          </div>
        )
      }

      if (sectionKey === 'vision' && project.vision) {
        return (
          <div id="section-vision" data-section="vision">
            <Vision
              portrait={project.vision.portrait}
              name={project.vision.name}
              text={project.vision.text}
              credentials={project.vision.credentials}
            />
          </div>
        )
      }

      if (sectionKey === 'themes' && project.themes) {
        return (
          <div id="section-themes" data-section="themes">
            <Themes
              headline={project.themes.headline}
              text={project.themes.text}
              points={project.themes.points}
            />
          </div>
        )
      }

      if (sectionKey === 'credibility' && project.credibility) {
        return (
          <div id="section-credibility" data-section="credibility">
            <Credibility
              awards={project.credibility.awards}
              collaborators={project.credibility.collaborators}
              press={project.credibility.press}
            />
          </div>
        )
      }

      if (sectionKey === 'cta' && project.cta) {
        return (
          <div id="section-cta" data-section="cta">
            <CTA
              headline={project.cta.headline}
              text={project.cta.text}
              contactEmail={project.cta.contact_email}
              links={project.cta.links}
            />
          </div>
        )
      }

      return null
    })}
  </main>
</Layout>
